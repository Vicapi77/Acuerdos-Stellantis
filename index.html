
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Stellantis - Cloud Sync</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #003366; --secondary: #f4f4f4; --success: #28a745; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: sans-serif; background: var(--secondary); padding: 20px; }
        .kpi-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 8px; flex: 1; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; }
        .btn-add { background: var(--success); margin-bottom: 15px; }
        .loading { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Dashboard Ejecutivo Stellantis</h1>
        <p id="status-cloud" class="loading">Sincronizando con Firebase...</p>
    </div>

    <div class="kpi-container">
        <div class="kpi-card"> <h2 id="kpi-total">0</h2> <small>TOTAL ACUERDOS</small> </div>
        <div class="kpi-card"> <h2 id="kpi-avg">0%</h2> <small>AVANCE GLOBAL</small> </div>
        <div class="kpi-card"> <h2 id="kpi-ok" style="color:var(--success)">0</h2> <small>COMPLETOS</small> </div>
    </div>

    <button class="btn btn-add" onclick="addRow()">+ Agregar Nuevo Acuerdo</button>

    <table>
        <thead>
            <tr>
                <th>Área</th>
                <th>Tema / Problema</th>
                <th>Acción / Contramedida</th>
                <th>Responsable</th>
                <th>Avance (%)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>

    <script>
        // --- CONFIGURACIÓN DE FIREBASE (CORREGIDA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCsMH4Zggn5XcgHJNai7h-mtmTbAbTLP1o",
            authDomain: "dashboard-stellantis-c34d5.firebaseapp.com",
            projectId: "dashboard-stellantis-c34d5",
            storageBucket: "dashboard-stellantis-c34d5.firebasestorage.app",
            messagingSenderId: "938441957804",
            appId: "1:938441957804:web:c729cea65c7eebe7275a09"
        };

        // Inicializar Firebase usando la versión Compat
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const collectionName = "acuerdos_stellantis";

        // --- LÓGICA DEL DASHBOARD ---

        // Leer datos en tiempo real
        db.collection(collectionName).onSnapshot((snapshot) => {
            const data = [];
            snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
            renderTable(data);
            document.getElementById('status-cloud').innerText = "☁ Conectado y Sincronizado";
            document.getElementById('status-cloud').style.color = "#28a745";
        }, (error) => {
            console.error("Error de Firebase: ", error);
            document.getElementById('status-cloud').innerText = "❌ Error de conexión (Revisa las reglas de Firestore)";
            document.getElementById('status-cloud').style.color = "red";
        });

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            let totalAvance = 0;
            let completos = 0;

            data.forEach(item => {
                const avanceNum = parseInt(item.avance) || 0;
                totalAvance += avanceNum;
                if(avanceNum >= 100) completos++;

                tbody.innerHTML += `
                    <tr>
                        <td contenteditable="true" onblur="updateField('${item.id}', 'area', this.innerText)">${item.area || ''}</td>
                        <td contenteditable="true" onblur="updateField('${item.id}', 'tema', this.innerText)">${item.tema || ''}</td>
                        <td contenteditable="true" onblur="updateField('${item.id}', 'accion', this.innerText)">${item.accion || ''}</td>
                        <td contenteditable="true" onblur="updateField('${item.id}', 'resp', this.innerText)">${item.resp || ''}</td>
                        <td>
                            <input type="number" value="${avanceNum}" style="width:60px" 
                                   onchange="updateField('${item.id}', 'avance', this.value)"> %
                        </td>
                        <td>
                            <button class="btn" style="background:var(--danger)" onclick="deleteDoc('${item.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('kpi-total').innerText = data.length;
            document.getElementById('kpi-avg').innerText = data.length > 0 ? Math.round(totalAvance/data.length) + '%' : '0%';
            document.getElementById('kpi-ok').innerText = completos;
        }

        async function updateField(id, field, value) {
            try {
                await db.collection(collectionName).doc(id).update({ [field]: value });
            } catch (e) { console.error("Error al actualizar: ", e); }
        }

        async function addRow() {
            try {
                await db.collection(collectionName).add({
                    area: "Nueva Área",
                    tema: "Nuevo Tema",
                    accion: "Nueva Acción",
                    resp: "Nombre",
                    avance: 0
                });
            } catch (e) { alert("Error: Verifica las Reglas de Firestore en la consola de Firebase"); }
        }

        async function deleteDoc(id) {
            if(confirm("¿Estás seguro de eliminar este registro?")) {
                await db.collection(collectionName).doc(id).delete();
            }
        }
    </script>
</body>
</html>
